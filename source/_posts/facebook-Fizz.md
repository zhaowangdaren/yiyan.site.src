---
title: Facebook:使用高性能的开源TLS库Fizz大规模部署TLS1.3
date: 2018-08-22 19:15:28
tags: TLS1.3 Facebook
---
[原文](https://code.fb.com/networking-traffic/deploying-tls-1-3-at-scale-with-fizz-a-performant-open-source-tls-library/)
新一代传输层安全协议TLS1.3增加了几项新功能，可以使互联网流量更加安全，包括加密握手消息以保证证书私密，重新设计密钥的派生方式，以及零往返连接设置，这使得某些请求比TLS1.2快。每天有超过10亿人使用Facebook与他们的朋友和家人联系，正是TLS1.3将他们的数据从应用程序传输到我们的服务器（然后，我们把数据提供给别人...最近用户隐私把Facebook折腾的够呛）。为了在Facebook上实现TLS1.3，我们创建了Fizz：一个用C++14编写的强大、高性能的TLS库。除了TLS1.3附带的协议增强功能外，Fizz还提供了许多功能，包括默认支持异步I/O，以及分散和收集I/O以消除对额外数据副本的需求。

我们现在已经在我们的移动应用程序Proxygen、负载均衡器、内部服务，甚至我们的QUIC库mvfst中全局部署了Fizz和TLS1.3。现在，Facebook超过50%的互联网流量使用了TLS1.3进行保护。在我们的移动应用程序上部署了TLS1.3的新特性：0个RTT发送数据。Fizz现在每秒处理数百万次TLS1.3握手。我们相信这使Fizz成为互联网上TLS1.3和0-RTT往返数据的最大部署。Fizz不仅减少了延迟，还减少了每天执行数万亿请求的服务器CPU的使用率。我们很高兴能够开源Fizz，以帮助加速在互联网上部署TLS1.3，并帮助其他人使他们的应用和服务更快、更安全。

## 性能
我们的团队与互联网工程任务组（IETF）合作多年，致力于标准化TLS1.3。以前，为了提高TLS的安全性和性能，我们部署了[Zero协议](https://code.fb.com/networking-traffic/building-zero-protocol-for-fast-secure-mobile-connections/)。这是一种私有协议，允许我们尝试建立0-RTT安全连接。使用0-RTT数据可减少使用TLS的请求延迟以及部署TLS所需的延迟开销。Fizz提供与Zero洗衣相同的TLS1.3的可靠性和性能，因此我们使用TLS1.3取代了我们的Zero协议部署。

性能也是Fizz关注的重点。通过零拷贝加解密，与我们基础架构的其他部分紧密集成以及其他优化，我们发现Fizz减少了内存和CPU的占用率。我们的负载均衡器综合基准测试显示，吞吐量比我们之前的堆栈高出约10%，但是我们不会骄傲，我们将会继续致力于提供Fizz性能。

通Zero协议一样，相比于TLS1.2，TLS1.3在握手阶段建立安全连接时显著减少了延迟。这样可以改善用户体验，尤其是在没有可重用连接的时候，比如应用程序启动时。

减少延迟的百分比（TLS1.3与TLS1.2在建立连接时）
<div style="text-align: center;">
  <img src="table_fizz.png"/>
</div>

## 默认异步
在TLS的现代部署中，服务器遍布全球。TLS负载均衡器位于一个位置是常见的，而TLS证书签名密钥由位于世界各地的另一个安全服务提供。像无密钥SSL（更像是一种拆分握手过程，私钥解密在一台服务器上，其他步骤可以在其他服务器上完成）之类的技术，被运用到将加密计算分发到不同的主机。

由于服务器通常希望能够在握手过程中能够调用其他服务，因此异步IO变得非常重要。当我们在编写Fizz时，我们希望将多个功能拆解到其他远程的服务器上，例如证书操作。因此，Fizz服务默认情况下是异步的。我们利用[futures](https://code.fb.com/developer-tools/futures-for-c-11-at-facebook/)来提供一个简单的异步API，来自Fizz的任何回调都可以异步相应，而不会阻止服务处理其他握手。对于其他用例，向Fizz添加新的异步回调也非常容易。

## 零拷贝写
多个库中的TLS APIs要求用户提供连续的内存块。TLS库加密连续内存块中的数据并将其写入socket中。然后，应用程序通常以不同存储器位置中的几个数据块的形式将数据保存在存储器中，而不是存储在一个连续的存储器块中。在其他库中，应用程序需要将数据拷贝到连续的内存位置，以便将其提供给TLS库。此复制操作会增加延迟开销。Fizz拥有支持分散、聚合I/O的API，其所有API都默认接受分散、聚合的抽象作为输入。这允许用户传入分块数据，然后Fizz将数据加密到分块内存中，从而避免了复制数据的需要。因此，使用Fizz的应用程序执行的内存分配和副本更少，这是高性能应用程序的一个重要考虑因素。
<div style="text-align: center;">
  <img src="fizz_new_chart_2"/>
</div>